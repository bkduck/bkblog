---
title: Golang进阶系列——栈内存管理
excerpt: Go程序在运行时刻每个协程维护一个栈，这个栈是预申请的内存段，它被作为一个内存池供开辟内存使用。每个协程的初始栈比较小，协程在运行时候将按照需要进行增长或收缩一个协程开辟在栈上的内存只能在此协程内部被引用，其它协程是无法访问的。
index_img: https://static.bkduck.cn/img/blog/go-202109281118.png
date: 2021-08-15
updated: 2021-08-15
categories:
  - Golang
tags:
  - golang
  - go进阶  
---


## 内存逃逸分析

Go 语言的逃逸分析遵循以下两个不变性:

1. 指向栈对象的指针不能存在于堆中；
2. 指向栈对象的指针不能在栈对象回收后存活；

----

栈空间不足导致的扩容会经历以下几个步骤：

1. 在内存空间中分配更大的栈内存空间；
2. 将旧栈中的所有内容复制到新栈中；
3. **将指向旧栈对应变量的指针重新指向新栈**；
4. 销毁并回收旧栈的内存空间；

在扩容的过程中，最重要的是调整指针的第三步，这一步能够保证指向栈的指针的正确性，因为栈中的所有变量内存都会发生变化，所以原本指向栈中变量的指针也需要调整。我们在前面提到过经过逃逸分析的 Go 语言程序的遵循以下不变性 —— **指向栈对象的指针不能存在于堆中**，所以指向栈中变量的指针只能在栈上，我们只需要调整栈中的所有变量就可以保证内存的安全了



## 栈拓容和缩容

### 栈缩容

运行时只会在栈内存使用不足 1/4 时进行缩容，新栈的大小会是原始栈的一半，不过如果新栈的大小低于程序的最低限制 2KB，那么缩容的过程就会停止。